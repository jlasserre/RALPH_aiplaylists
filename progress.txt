## Codebase Patterns
- Next.js 16.1.2 with App Router (src/app/ directory structure)
- TypeScript strict mode enabled
- Tailwind CSS v4 with `@import "tailwindcss"` syntax
- Path alias `@/*` maps to `./src/*`
- Jest 30 with next/jest helper for Next.js integration
- Tests co-located with source files (`.test.ts`, `.test.tsx`)
- localStorage is mocked in jest.setup.js - mocks auto-clear before each test
- Web Crypto API (TextEncoder, crypto.subtle) polyfilled in jest.setup.js for jsdom

---

## 2026-01-15 - US-001
- What was implemented: Initialized Next.js project with TypeScript and Tailwind CSS
- Files changed:
  - package.json - project config with ai-playlist-generator name
  - tsconfig.json - TypeScript config with strict mode
  - src/app/layout.tsx - root layout with metadata
  - src/app/page.tsx - basic home page component
  - src/app/globals.css - Tailwind CSS imports and theme variables
  - eslint.config.mjs - ESLint configuration
  - next.config.ts - Next.js configuration
  - postcss.config.mjs - PostCSS config for Tailwind
- **Learnings for future iterations:**
  - create-next-app refuses to create projects in directories with capital letters in the name - use temp directory workaround
  - next-env.d.ts is auto-generated and gitignored - don't try to add it
  - Next.js 16 uses Tailwind v4 with new `@import "tailwindcss"` syntax instead of @tailwind directives
---

## 2026-01-15 - US-002
- What was implemented: Installed dependencies and created environment config
- Files changed:
  - package.json - added zustand, @anthropic-ai/sdk, openai dependencies
  - package-lock.json - updated with new dependencies
  - .env.local.example - created with Spotify OAuth and LLM API key placeholders
  - src/types/index.ts - created with comprehensive type definitions (Song, SpotifyTrack, PlaylistSong, CandidateSong, API responses, etc.)
  - .gitignore - added exception for .env.local.example
- **Learnings for future iterations:**
  - .gitignore has `.env*` pattern that blocks .env.local.example - need to add explicit exception `!.env.local.example`
  - Type definitions created early help maintain consistency across the codebase
---

## 2026-01-15 - US-002b
- What was implemented: Set up Jest and React Testing Library for unit and component testing
- Files changed:
  - package.json - added jest, @testing-library/react, @testing-library/jest-dom, jest-environment-jsdom, @types/jest, ts-node; added test/test:watch/test:coverage/typecheck scripts
  - jest.config.js - created with next/jest helper, jsdom environment, module aliases
  - jest.setup.js - created with @testing-library/jest-dom import and localStorage mock
  - src/types/index.test.ts - sample test file verifying types and localStorage mock
- **Learnings for future iterations:**
  - Use `next/jest` helper (createJestConfig) for seamless Next.js integration
  - Jest 30 works with Next.js 16 - no compatibility issues
  - localStorage mock should clear mocks in beforeEach to ensure test isolation
  - The `typecheck` script (`tsc --noEmit`) is useful for CI validation
---

## 2026-01-15 - US-003
- What was implemented: PKCE utility functions for Spotify OAuth
- Files changed:
  - src/lib/spotify/auth.ts - created with generateCodeVerifier, generateCodeChallenge, generateRandomState functions
  - src/lib/spotify/auth.test.ts - comprehensive tests for all PKCE functions
  - jest.setup.js - added TextEncoder, TextDecoder, and crypto.subtle polyfills for Web Crypto API support
- **Learnings for future iterations:**
  - jsdom environment doesn't include TextEncoder/TextDecoder - import from 'util' and set on global
  - jsdom doesn't have crypto.subtle - use webcrypto from 'crypto' module and define on global.crypto
  - Jest 30 uses `--testPathPatterns` instead of `--testPathPattern` (or just pass file path directly)
  - RFC 7636 PKCE test vector: verifier "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk" produces challenge "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM"
---

## 2026-01-15 - US-004
- What was implemented: Spotify OAuth initiation API route
- Files changed:
  - src/app/api/auth/spotify/route.ts - GET handler that generates PKCE values, stores them in httpOnly cookies, and redirects to Spotify authorization
- **Learnings for future iterations:**
  - Next.js 16 cookies() is async - must await the call before using set()
  - Cookie options: httpOnly for security, sameSite 'lax' for OAuth redirects, secure in production only
  - Spotify OAuth scopes: playlist-read-private, playlist-modify-public, playlist-modify-private are needed for this app
  - Store both code_verifier (for token exchange) and state (for CSRF protection) in cookies
---

## 2026-01-15 - US-005
- What was implemented: Spotify OAuth callback API route that completes the PKCE flow
- Files changed:
  - src/app/api/auth/spotify/callback/route.ts - GET handler that exchanges auth code for tokens
- **Learnings for future iterations:**
  - When setting/deleting cookies in a redirect response, use `response.cookies.set()` and `response.cookies.delete()` instead of the `cookies()` store directly
  - Spotify returns tokens as JSON with: access_token, token_type, scope, expires_in, refresh_token
  - Store both refresh_token (30 days) and access_token (expires_in from response) in httpOnly cookies
  - The access_token cookie is temporary - it will be read by /api/auth/refresh on page load
  - Clear temporary OAuth cookies (state, code_verifier) on successful token exchange
---
